<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSeed - Web Call Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .debug-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .debug-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status.success {
            background: rgba(39, 174, 96, 0.3);
            border: 1px solid #27ae60;
        }
        
        .status.error {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
        }
        
        .status.loading {
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(238, 90, 36, 0.4);
            font-weight: bold;
            margin: 10px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(238, 90, 36, 0.6);
        }
        
        button:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: none;
        }
        
        .button-group {
            text-align: center;
            margin: 30px 0;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Web Call Debug Tool</h1>
        
        <div class="debug-section">
            <div class="debug-title">üìä Debug Console:</div>
            <div id="debug-console"></div>
        </div>
        
        <div class="button-group">
            <button onclick="testVAPIConfig()">1. Test VAPI Config</button>
            <button onclick="loadVAPISDK()">2. Load VAPI SDK</button>
            <button onclick="testVAPICall()">3. Test VAPI Call</button>
            <button onclick="testSimpleCall()">4. Simple Call Test</button>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">‚öôÔ∏è Configuration Status:</div>
            <div id="config-status"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">üìù Instructions:</div>
            <ol>
                <li>Click "Test VAPI Config" to verify server configuration</li>
                <li>Click "Load VAPI SDK" to load the VAPI JavaScript library</li>
                <li>Click "Test VAPI Call" to attempt a call with full debugging</li>
                <li>Check browser console (F12) for additional errors</li>
            </ol>
        </div>
    </div>

    <script>
        let VAPI_CONFIG = null;
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            debugLog.push(entry);
            
            const console = document.getElementById('debug-console');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = entry;
            console.appendChild(div);
            
            // Also log to browser console
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }
        
        // Test VAPI Configuration
        async function testVAPIConfig() {
            log('Testing VAPI configuration...', 'loading');
            
            try {
                const response = await fetch('/api/vapi-config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                VAPI_CONFIG = await response.json();
                log('‚úÖ VAPI config loaded successfully', 'success');
                
                const configDiv = document.getElementById('config-status');
                configDiv.innerHTML = `
                    <div class="status success">
                        <strong>Configuration Loaded:</strong><br>
                        Public Key: ${VAPI_CONFIG.publicKey}<br>
                        Assistant ID: ${VAPI_CONFIG.assistantId}<br>
                        Webhook URL: ${VAPI_CONFIG.webhookUrl}
                    </div>
                `;
                
                // Check if this is actually a public key or private key
                if (VAPI_CONFIG.publicKey && !VAPI_CONFIG.publicKey.startsWith('pk_')) {
                    log('‚ö†Ô∏è Warning: API key does not start with "pk_" - might be a private key', 'error');
                    log('VAPI web SDK requires a PUBLIC key (starts with pk_)', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Failed to load VAPI config: ${error.message}`, 'error');
                document.getElementById('config-status').innerHTML = `
                    <div class="status error">
                        Failed to load configuration: ${error.message}
                    </div>
                `;
            }
        }
        
        // Load VAPI SDK
        function loadVAPISDK() {
            log('Loading VAPI SDK...', 'loading');
            
            // First check if it's already loaded
            if (window.vapiSDK) {
                log('‚úÖ VAPI SDK already loaded', 'success');
                return;
            }
            
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js';
            script.async = true;
            script.defer = true;
            
            script.onload = () => {
                log('‚úÖ VAPI SDK script loaded', 'success');
                
                // Check what's available on window
                if (window.vapiSDK) {
                    log('‚úÖ window.vapiSDK is available', 'success');
                    
                    // Log available methods
                    const methods = Object.keys(window.vapiSDK);
                    log(`Available vapiSDK methods: ${methods.join(', ')}`, 'success');
                } else if (window.Vapi) {
                    log('‚úÖ window.Vapi is available (different SDK version)', 'success');
                } else {
                    log('‚ö†Ô∏è VAPI SDK loaded but not found on window object', 'error');
                }
            };
            
            script.onerror = (error) => {
                log(`‚ùå Failed to load VAPI SDK: ${error}`, 'error');
            };
            
            document.head.appendChild(script);
        }
        
        // Test VAPI Call
        async function testVAPICall() {
            log('Testing VAPI call...', 'loading');
            
            if (!VAPI_CONFIG) {
                log('‚ùå Please load VAPI config first', 'error');
                return;
            }
            
            if (!window.vapiSDK && !window.Vapi) {
                log('‚ùå Please load VAPI SDK first', 'error');
                return;
            }
            
            try {
                // Try different SDK patterns
                if (window.vapiSDK) {
                    log('Attempting call with window.vapiSDK...', 'loading');
                    
                    if (window.vapiSDK.run) {
                        log('Using vapiSDK.run() method...', 'loading');
                        const instance = window.vapiSDK.run({
                            apiKey: VAPI_CONFIG.publicKey,
                            assistant: VAPI_CONFIG.assistantId,
                            metadata: {
                                source: 'debug-test'
                            }
                        });
                        log('‚úÖ Call initiated with vapiSDK.run()', 'success');
                        
                    } else if (window.vapiSDK.start) {
                        log('Using vapiSDK.start() method...', 'loading');
                        await window.vapiSDK.start({
                            apiKey: VAPI_CONFIG.publicKey,
                            assistant: VAPI_CONFIG.assistantId,
                            metadata: {
                                source: 'debug-test'
                            }
                        });
                        log('‚úÖ Call initiated with vapiSDK.start()', 'success');
                    } else {
                        log('‚ùå No known start method on vapiSDK', 'error');
                    }
                    
                } else if (window.Vapi) {
                    log('Using window.Vapi constructor...', 'loading');
                    const vapi = new window.Vapi(VAPI_CONFIG.publicKey);
                    
                    vapi.on('call-start', () => {
                        log('‚úÖ Call started!', 'success');
                    });
                    
                    vapi.on('call-end', () => {
                        log('üìû Call ended', 'success');
                    });
                    
                    vapi.on('error', (error) => {
                        log(`‚ùå Call error: ${JSON.stringify(error)}`, 'error');
                    });
                    
                    await vapi.start(VAPI_CONFIG.assistantId);
                    log('‚úÖ Call initiated with Vapi constructor', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Call failed: ${error.message}`, 'error');
                log(`Full error: ${JSON.stringify(error)}`, 'error');
            }
        }
        
        // Simple test without metadata
        async function testSimpleCall() {
            log('Testing simple call (minimal parameters)...', 'loading');
            
            if (!VAPI_CONFIG) {
                await testVAPIConfig();
                if (!VAPI_CONFIG) return;
            }
            
            if (!window.vapiSDK && !window.Vapi) {
                loadVAPISDK();
                setTimeout(testSimpleCall, 2000);
                return;
            }
            
            try {
                // Try the simplest possible call
                if (window.Vapi) {
                    log('Trying Vapi constructor pattern...', 'loading');
                    const vapi = new window.Vapi(VAPI_CONFIG.publicKey);
                    await vapi.start(VAPI_CONFIG.assistantId);
                    log('‚úÖ Simple call started!', 'success');
                } else {
                    log('‚ùå Vapi constructor not available', 'error');
                    log('Available on window: ' + Object.keys(window).filter(k => k.toLowerCase().includes('vapi')).join(', '), 'error');
                }
            } catch (error) {
                log(`‚ùå Simple call failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-load config on page load
        window.addEventListener('DOMContentLoaded', () => {
            log('Debug page loaded - Click buttons to test', 'success');
        });
    </script>

    <!-- DreamSeed Unified Navigation -->
    <script src="/components/unified-header.js"></script>
</body>
</html>