<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSeed - Your Business Formation Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            text-align: center;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .welcome-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .info-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }
        
        .info-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }
        
        .progress-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }
        
        .progress-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
        }
        
        .calls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .call-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .call-card.completed {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }
        
        .call-card.current {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            animation: glow 2s infinite alternate;
        }
        
        .call-card.pending {
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            to { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
        }
        
        .call-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .call-status {
            font-size: 0.9em;
            opacity: 0.8;
            margin: 10px 0;
        }
        
        .call-description {
            font-size: 0.95em;
            line-height: 1.4;
            margin: 15px 0;
        }
        
        .action-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .call-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.3em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(238, 90, 36, 0.4);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 10px;
        }
        
        .call-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(238, 90, 36, 0.6);
        }
        
        .call-button:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        
        .next-steps {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: left;
        }
        
        .next-steps h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .next-steps ul {
            list-style: none;
            padding: 0;
        }
        
        .next-steps li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .next-steps li:before {
            content: "‚úì ";
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå± DreamSeed Business Formation</h1>
    </div>
    
    <div class="dashboard">
        <div class="loading" id="loading">
            Loading your dashboard...
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <h2 id="welcome-message">Welcome back!</h2>
                <div class="customer-info">
                    <div class="info-card">
                        <div class="info-label">Business Name</div>
                        <div class="info-value" id="business-name">Loading...</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Formation State</div>
                        <div class="info-value" id="formation-state">Loading...</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Business Type</div>
                        <div class="info-value" id="business-type">Loading...</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Progress</div>
                        <div class="info-value" id="progress-percentage">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div class="progress-section">
                <div class="progress-header">
                    <h2>Your Business Formation Journey</h2>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-bar" style="width: 0%;">0%</div>
                    </div>
                </div>
                
                <div class="calls-grid" id="calls-grid">
                    <!-- Call cards will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Action Section -->
            <div class="action-section">
                <h2 id="action-title">Ready for Your Next Step?</h2>
                <p id="action-description">Continue your business formation journey with expert guidance.</p>
                
                <button class="call-button" id="start-call">
                    üé§ <span id="button-text">Talk to an Expert</span>
                </button>
                
                <div class="status-message" id="call-status">
                    Ready to continue your business formation
                </div>
                
                <div class="next-steps" id="next-steps">
                    <!-- Next steps will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load customer configuration from URL parameters
        function getCustomerConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            
            if (!email) {
                // If no email in URL, show error
                document.getElementById('loading').innerHTML = `
                    <h2>‚ö†Ô∏è Missing Customer Information</h2>
                    <p>Please access this dashboard through your personalized link.</p>
                    <p>Contact DreamSeed support if you need assistance.</p>
                `;
                return null;
            }
            
            return {
                email: email,
                phone: urlParams.get('phone') || '',
                name: urlParams.get('name') || '',
                business: urlParams.get('business') || ''
            };
        }
        
        const customerConfig = getCustomerConfig();
        if (!customerConfig) return; // Exit if no customer config
        
        // Server configuration
        const WEBHOOK_SERVER = "http://localhost:3002";
        let VAPI_CONFIG = null;
        let customerData = null;

        // Call stage definitions
        const callStages = {
            1: {
                title: "üìã Call 1: Foundation & Vision",
                description: "Business concept, LLC requirements, timeline, and basic setup information",
                focus: "Establish your business foundation"
            },
            2: {
                title: "üé® Call 2: Brand DNA & Identity", 
                description: "Logo design, colors, website style, messaging, and brand personality",
                focus: "Develop your brand identity"
            },
            3: {
                title: "‚öôÔ∏è Call 3: Operations & Systems",
                description: "Business systems, compliance, banking, vendor relationships, and operations",
                focus: "Set up your business operations"
            },
            4: {
                title: "üöÄ Call 4: Launch Strategy",
                description: "Marketing plan, launch timeline, growth strategy, and ongoing support",
                focus: "Plan your business launch"
            },
            5: {
                title: "üéâ Formation Complete!",
                description: "Business coaching, scaling support, and growth acceleration services",
                focus: "Grow and scale your business"
            }
        };

        // Load VAPI configuration
        async function loadVAPIConfig() {
            try {
                const response = await fetch(`${WEBHOOK_SERVER}/api/vapi-config`);
                if (response.ok) {
                    VAPI_CONFIG = await response.json();
                    console.log('üé§ VAPI config loaded');
                } else {
                    throw new Error('Failed to load VAPI config');
                }
            } catch (error) {
                console.error('‚ùå VAPI config error:', error);
                updateStatus("Configuration error. Please contact support.", true);
            }
        }

        // Load customer data
        async function loadCustomerData() {
            try {
                const response = await fetch(`${WEBHOOK_SERVER}/api/customer-journey/${encodeURIComponent(customerConfig.email)}`);
                if (response.ok) {
                    const data = await response.json();
                    customerData = data.customer || {};
                    return customerData;
                } else {
                    // Customer not found - use URL parameters
                    customerData = {
                        customer_name: customerConfig.name,
                        customer_email: customerConfig.email,
                        customer_phone: customerConfig.phone,
                        business_name: customerConfig.business,
                        call_1_completed: false,
                        call_2_completed: false,
                        call_3_completed: false,
                        call_4_completed: false,
                        current_call_stage: 1
                    };
                    return customerData;
                }
            } catch (error) {
                console.error('‚ùå Customer data error:', error);
                customerData = {};
                return customerData;
            }
        }

        // Update dashboard UI
        function updateDashboard(customer) {
            // Welcome message
            const welcomeMsg = customer.customer_name ? 
                `Welcome back, ${customer.customer_name}!` : 
                'Welcome to DreamSeed!';
            document.getElementById('welcome-message').textContent = welcomeMsg;
            
            // Customer info cards
            document.getElementById('business-name').textContent = customer.business_name || 'TBD';
            document.getElementById('formation-state').textContent = customer.state_of_operation || 'TBD';
            document.getElementById('business-type').textContent = customer.business_type || 'TBD';
            
            // Calculate progress
            const calls = [
                customer.call_1_completed,
                customer.call_2_completed,
                customer.call_3_completed,
                customer.call_4_completed
            ];
            const completed = calls.filter(Boolean).length;
            const progressPercent = Math.round((completed / 4) * 100);
            
            document.getElementById('progress-percentage').textContent = `${completed}/4 Calls`;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('progress-bar').textContent = `${progressPercent}%`;
            
            // Determine current stage
            let currentStage = 1;
            if (customer.call_4_completed) {
                currentStage = 5; // Post-completion
            } else if (customer.call_3_completed) {
                currentStage = 4;
            } else if (customer.call_2_completed) {
                currentStage = 3;
            } else if (customer.call_1_completed) {
                currentStage = 2;
            }
            
            // Update call cards
            updateCallCards(calls, currentStage);
            
            // Update action section
            updateActionSection(currentStage, customer);
        }

        // Update call cards display
        function updateCallCards(completedCalls, currentStage) {
            const callsGrid = document.getElementById('calls-grid');
            callsGrid.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const isCompleted = completedCalls[i-1];
                const isCurrent = i === currentStage && currentStage <= 4;
                const isPending = i > currentStage;
                
                const card = document.createElement('div');
                card.className = `call-card ${isCompleted ? 'completed' : isCurrent ? 'current' : 'pending'}`;
                
                const statusIcon = isCompleted ? '‚úÖ' : isCurrent ? 'üîÑ' : '‚è≥';
                const statusText = isCompleted ? 'Completed' : isCurrent ? 'Ready to Start' : 'Coming Up';
                
                card.innerHTML = `
                    <div class="call-title">
                        ${statusIcon} ${callStages[i].title}
                    </div>
                    <div class="call-status">${statusText}</div>
                    <div class="call-description">${callStages[i].description}</div>
                `;
                
                callsGrid.appendChild(card);
            }
            
            // Add completion card if all done
            if (currentStage === 5) {
                const card = document.createElement('div');
                card.className = 'call-card current';
                card.innerHTML = `
                    <div class="call-title">
                        üéâ ${callStages[5].title}
                    </div>
                    <div class="call-status">Available Now</div>
                    <div class="call-description">${callStages[5].description}</div>
                `;
                callsGrid.appendChild(card);
            }
        }

        // Update action section
        function updateActionSection(stage, customer) {
            const actionTitle = document.getElementById('action-title');
            const actionDescription = document.getElementById('action-description');
            const buttonText = document.getElementById('button-text');
            const nextSteps = document.getElementById('next-steps');
            
            if (stage === 5) {
                // Post-completion
                actionTitle.textContent = "Congratulations! üéâ";
                actionDescription.textContent = "You've completed your business formation journey. Ready to scale and grow?";
                buttonText.textContent = "Get Growth Support";
                
                nextSteps.innerHTML = `
                    <h3>üöÄ Growth & Scaling Services Available:</h3>
                    <ul>
                        <li>Business coaching and mentorship</li>
                        <li>Marketing strategy development</li>
                        <li>Customer acquisition systems</li>
                        <li>Financial planning and funding</li>
                        <li>Technology and automation setup</li>
                        <li>Legal and compliance support</li>
                    </ul>
                `;
            } else {
                // In progress
                const currentCall = callStages[stage];
                actionTitle.textContent = `Ready for ${currentCall.title}?`;
                actionDescription.textContent = `Let's ${currentCall.focus.toLowerCase()} with expert guidance.`;
                buttonText.textContent = `Start ${currentCall.title.split(':')[0]}`;
                
                nextSteps.innerHTML = `
                    <h3>üìù In This Call We'll Cover:</h3>
                    <ul>
                        <li>${currentCall.description}</li>
                        <li>Review and build on previous progress</li>
                        <li>Identify next steps and priorities</li>
                        <li>Answer your specific questions</li>
                    </ul>
                `;
            }
        }

        // Update call status
        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('call-status');
            statusEl.textContent = message;
            statusEl.style.background = isError ? 
                'rgba(255, 0, 0, 0.3)' : 
                'rgba(0, 255, 0, 0.3)';
        }

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                await loadVAPIConfig();
                const customer = await loadCustomerData();
                updateDashboard(customer);
                
                // Show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
                // Initialize call button
                initializeCallButton();
                
            } catch (error) {
                console.error('‚ùå Dashboard initialization error:', error);
                document.getElementById('loading').innerHTML = `
                    <h2>‚ö†Ô∏è Error Loading Dashboard</h2>
                    <p>Please refresh the page or contact support.</p>
                `;
            }
        }

        // Initialize call button functionality
        function initializeCallButton() {
            // Load VAPI SDK
            const script = document.createElement('script');
            script.src = "https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js";
            script.async = true;
            script.defer = true;
            
            script.onload = () => {
                console.log('üé§ VAPI SDK loaded');
                setupCallButton();
            };
            
            script.onerror = () => {
                updateStatus("Could not load call system. Please refresh the page.", true);
            };
            
            document.head.appendChild(script);
        }

        // Setup call button event handler
        function setupCallButton() {
            const callButton = document.getElementById('start-call');
            
            callButton.addEventListener('click', async () => {
                try {
                    if (!VAPI_CONFIG) {
                        throw new Error('VAPI configuration not loaded');
                    }
                    
                    updateStatus("Starting call...");
                    callButton.disabled = true;
                    
                    // Notify server about web call start
                    try {
                        await fetch(`${WEBHOOK_SERVER}/api/vapi-webhook`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: "call-start",
                                callId: "dashboard-call-" + Date.now(),
                                call: {
                                    id: "dashboard-call-" + Date.now(),
                                    type: "inbound",
                                    customer: {
                                        number: customerConfig.phone
                                    }
                                }
                            })
                        });
                    } catch (notifyError) {
                        console.log('Could not notify server, continuing with call');
                    }

                    // Start VAPI call
                    const userContext = {
                        email: customerConfig.email,
                        phone: customerConfig.phone,
                        name: customerConfig.name,
                        business: customerConfig.business,
                        sessionTag: "dashboard-call",
                        source: "customer-dashboard"
                    };

                    if (window.vapiSDK) {
                        if (window.vapiSDK.run) {
                            window.vapiInstance = window.vapiSDK.run({
                                apiKey: VAPI_CONFIG.publicKey,
                                assistant: VAPI_CONFIG.assistantId,
                                metadata: userContext
                            });
                        } else if (window.vapiSDK.start) {
                            await window.vapiSDK.start({
                                apiKey: VAPI_CONFIG.publicKey,
                                assistant: VAPI_CONFIG.assistantId,
                                metadata: userContext
                            });
                        }
                        updateStatus("Call connected! Speak now...");
                    } else {
                        throw new Error('VAPI SDK not loaded');
                    }
                    
                } catch (error) {
                    console.error("‚ùå Call start error:", error);
                    updateStatus("Could not start call: " + error.message, true);
                    callButton.disabled = false;
                }
            });

            // Listen for VAPI events
            if (window.vapiSDK && window.vapiSDK.on) {
                window.vapiSDK.on('call-start', () => {
                    updateStatus("Call started - speak now!");
                });
                
                window.vapiSDK.on('call-end', () => {
                    updateStatus("Call ended. Thank you!");
                    callButton.disabled = false;
                    // Reload customer data to show updated progress
                    setTimeout(() => {
                        initializeDashboard();
                    }, 3000);
                });
                
                window.vapiSDK.on('error', (error) => {
                    updateStatus("Call error: " + error.message, true);
                    callButton.disabled = false;
                });
            }
        }

        // Start dashboard initialization
        initializeDashboard();
    </script>

    <!-- DreamSeed Unified Navigation -->
    <script src="/components/unified-header.js"></script>
</body>
</html>