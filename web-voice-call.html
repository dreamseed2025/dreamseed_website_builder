<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSeed - Web Voice Call</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .call-interface {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            margin: 30px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .call-controls {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .start-call-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            width: 120px;
            height: 120px;
            font-size: 2.5em;
        }
        
        .start-call-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(39, 174, 96, 0.4);
        }
        
        .mute-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }
        
        .mute-btn.muted {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .hangup-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
        }
        
        .control-btn:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: none;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            font-size: 1.2em;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #95a5a6;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #27ae60;
        }
        
        .status-dot.speaking {
            background: #3498db;
            animation: pulse 0.5s infinite;
        }
        
        .status-dot.listening {
            background: #f39c12;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .volume-indicator {
            display: flex;
            justify-content: center;
            gap: 3px;
            margin: 15px 0;
        }
        
        .volume-bar {
            width: 4px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            transition: all 0.1s ease;
        }
        
        .debug-panel {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ DreamSeed Voice Consultation</h1>
        <p>Start a voice conversation with our AI business consultant</p>
        
        <div class="call-interface">
            <!-- Start Call Interface -->
            <div id="start-interface">
                <button id="start-call-btn" class="control-btn start-call-btn" onclick="startWebCall()">
                    üìû
                </button>
                <p style="margin-top: 20px;">Click to start voice consultation</p>
            </div>
            
            <!-- Active Call Interface -->
            <div id="call-interface" class="hidden">
                <div class="status-indicator">
                    <div id="status-dot" class="status-dot"></div>
                    <span id="status-text">Connecting...</span>
                </div>
                
                <div class="volume-indicator" id="volume-indicator">
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                </div>
                
                <div class="call-controls">
                    <button id="mute-btn" class="control-btn mute-btn" onclick="toggleMute()">
                        üé§
                    </button>
                    <button id="hangup-btn" class="control-btn hangup-btn" onclick="endCall()">
                        üìû
                    </button>
                </div>
                
                <p><strong>Tip:</strong> Speak clearly and wait for the AI to respond</p>
            </div>
        </div>
        
        <div class="debug-panel">
            <div style="color: #ffd700; font-weight: bold; margin-bottom: 10px;">Call Status:</div>
            <div id="debug-output">Initializing...</div>
        </div>
    </div>

    <!-- VAPI Web SDK with multiple fallbacks -->
    <script>
        // Try multiple CDN sources for VAPI SDK
        const loadVAPISDK = () => {
            const cdnSources = [
                'https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/index.js',
                'https://unpkg.com/@vapi-ai/web@latest/dist/index.js',
                'https://cdn.skypack.dev/@vapi-ai/web@latest',
                'https://esm.sh/@vapi-ai/web@latest'
            ];
            
            let currentIndex = 0;
            
            const tryLoadScript = () => {
                if (currentIndex >= cdnSources.length) {
                    console.error('All VAPI SDK sources failed to load');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdnSources[currentIndex];
                script.onload = () => {
                    console.log(`VAPI SDK loaded from: ${cdnSources[currentIndex]}`);
                };
                script.onerror = () => {
                    console.log(`Failed to load from: ${cdnSources[currentIndex]}`);
                    currentIndex++;
                    tryLoadScript();
                };
                document.head.appendChild(script);
            };
            
            tryLoadScript();
        };
        
        loadVAPISDK();
    </script>
    
    <script>
        let vapi = null;
        let isCallActive = false;
        let isMuted = false;
        let config = null;
        
        // Debug logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const debugOutput = document.getElementById('debug-output');
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#ffffff';
            entry.textContent = `[${timestamp}] ${message}`;
            debugOutput.appendChild(entry);
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(`[VAPI] ${message}`);
        }
        
        // Update status indicator
        function updateStatus(text, state = 'idle') {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = text;
            statusDot.className = `status-dot ${state}`;
        }
        
        // Volume visualization
        function updateVolumeIndicator(level = 0) {
            const bars = document.querySelectorAll('.volume-bar');
            const activeBars = Math.floor((level / 100) * bars.length);
            
            bars.forEach((bar, index) => {
                if (index < activeBars) {
                    bar.style.background = '#3498db';
                    bar.style.height = `${20 + (index * 3)}px`;
                } else {
                    bar.style.background = 'rgba(255, 255, 255, 0.3)';
                    bar.style.height = '20px';
                }
            });
        }
        
        // Load VAPI configuration
        async function loadConfig() {
            try {
                log('Loading VAPI configuration...');
                const response = await fetch('/api/vapi-config');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                config = await response.json();
                log(`‚úÖ Configuration loaded: ${config.publicKey}`, 'success');
                return true;
            } catch (error) {
                log(`‚ùå Failed to load configuration: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Initialize VAPI
        async function initializeVAPI() {
            try {
                log('Checking VAPI SDK availability...');
                
                // Wait for VAPI SDK to load
                let attempts = 0;
                while (typeof window.Vapi === 'undefined' && attempts < 20) {
                    log(`Waiting for VAPI SDK... (attempt ${attempts + 1})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (typeof window.Vapi === 'undefined') {
                    throw new Error('VAPI SDK failed to load. Please refresh the page.');
                }
                
                log('‚úÖ VAPI SDK loaded', 'success');
                
                // Load configuration
                if (!config) {
                    const configLoaded = await loadConfig();
                    if (!configLoaded) {
                        throw new Error('Could not load VAPI configuration');
                    }
                }
                
                // Initialize VAPI with public key
                log(`Initializing VAPI with key: ${config.publicKey.substring(0, 8)}...`);
                vapi = new window.Vapi(config.publicKey);
                
                // Set up event listeners
                setupVAPIEventListeners();
                
                log('‚úÖ VAPI initialized successfully', 'success');
                updateStatus('Ready to start call');
                return true;
                
            } catch (error) {
                log(`‚ùå VAPI initialization failed: ${error.message}`, 'error');
                updateStatus(`Initialization failed: ${error.message}`);
                return false;
            }
        }
        
        // Setup VAPI event listeners
        function setupVAPIEventListeners() {
            vapi.on('call-start', () => {
                log('üìû Call started!', 'success');
                isCallActive = true;
                updateStatus('Connected - You can speak now', 'connected');
                showCallInterface();
            });
            
            vapi.on('call-end', () => {
                log('üìû Call ended', 'success');
                isCallActive = false;
                isMuted = false;
                updateStatus('Call ended');
                showStartInterface();
                updateVolumeIndicator(0);
            });
            
            vapi.on('speech-start', () => {
                log('üé§ You started speaking');
                updateStatus('Listening to you...', 'listening');
            });
            
            vapi.on('speech-end', () => {
                log('üîá You stopped speaking');
                updateStatus('AI is thinking...', 'connected');
            });
            
            vapi.on('assistant-speech-start', () => {
                log('ü§ñ AI started speaking');
                updateStatus('AI is speaking...', 'speaking');
            });
            
            vapi.on('assistant-speech-end', () => {
                log('ü§ñ AI finished speaking');
                updateStatus('Your turn to speak', 'connected');
            });
            
            vapi.on('volume-level', (level) => {
                updateVolumeIndicator(level);
            });
            
            vapi.on('error', (error) => {
                log(`‚ùå VAPI Error: ${JSON.stringify(error)}`, 'error');
                updateStatus(`Error: ${error.message || 'Unknown error'}`);
                isCallActive = false;
                showStartInterface();
            });
            
            vapi.on('message', (message) => {
                log(`üí¨ Message: ${JSON.stringify(message)}`);
            });
        }
        
        // Show start interface
        function showStartInterface() {
            document.getElementById('start-interface').classList.remove('hidden');
            document.getElementById('call-interface').classList.add('hidden');
            document.getElementById('start-call-btn').disabled = false;
        }
        
        // Show call interface
        function showCallInterface() {
            document.getElementById('start-interface').classList.add('hidden');
            document.getElementById('call-interface').classList.remove('hidden');
            updateMuteButton();
        }
        
        // Start web call
        async function startWebCall() {
            try {
                document.getElementById('start-call-btn').disabled = true;
                updateStatus('Starting call...', 'connecting');
                
                if (!vapi) {
                    log('VAPI not initialized, initializing now...');
                    const initialized = await initializeVAPI();
                    if (!initialized) {
                        throw new Error('Could not initialize VAPI');
                    }
                }
                
                log('Starting web call...');
                updateStatus('Connecting...', 'connecting');
                
                // Start the call with assistant configuration
                await vapi.start({
                    assistant: {
                        model: {
                            provider: 'openai',
                            model: 'gpt-3.5-turbo',
                            messages: [{
                                role: 'system',
                                content: 'You are a helpful business formation consultant for DreamSeed. Help customers understand the process of forming an LLC. Ask about their business goals, type, and state. Be friendly, professional, and keep the conversation focused on business formation. Limit responses to 2-3 sentences.'
                            }]
                        },
                        voice: {
                            provider: 'playht',
                            voiceId: 'jennifer'
                        },
                        firstMessage: "Hello! Welcome to DreamSeed. I'm your AI business consultant here to help you with LLC formation. What type of business are you looking to start?"
                    }
                });
                
                log('‚úÖ Call start command sent', 'success');
                
            } catch (error) {
                log(`‚ùå Call failed: ${error.message}`, 'error');
                updateStatus(`Call failed: ${error.message}`);
                document.getElementById('start-call-btn').disabled = false;
                isCallActive = false;
            }
        }
        
        // Toggle mute
        function toggleMute() {
            if (!vapi || !isCallActive) return;
            
            try {
                if (isMuted) {
                    vapi.setMuted(false);
                    isMuted = false;
                    log('üé§ Microphone unmuted');
                } else {
                    vapi.setMuted(true);
                    isMuted = true;
                    log('üîá Microphone muted');
                }
                updateMuteButton();
            } catch (error) {
                log(`‚ùå Mute toggle failed: ${error.message}`, 'error');
            }
        }
        
        // Update mute button appearance
        function updateMuteButton() {
            const muteBtn = document.getElementById('mute-btn');
            if (isMuted) {
                muteBtn.classList.add('muted');
                muteBtn.textContent = 'üîá';
            } else {
                muteBtn.classList.remove('muted');
                muteBtn.textContent = 'üé§';
            }
        }
        
        // End call
        function endCall() {
            if (!vapi || !isCallActive) return;
            
            try {
                log('Ending call...');
                vapi.stop();
                updateStatus('Ending call...');
            } catch (error) {
                log(`‚ùå End call failed: ${error.message}`, 'error');
                // Force reset if stop() fails
                isCallActive = false;
                showStartInterface();
            }
        }
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            log('Page loaded, initializing...');
            
            // Check microphone permissions
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                log('‚úÖ Microphone access granted', 'success');
            } catch (error) {
                log(`‚ö†Ô∏è Microphone access denied: ${error.message}`, 'error');
                updateStatus('Please allow microphone access');
                return;
            }
            
            // Initialize VAPI
            setTimeout(async () => {
                await initializeVAPI();
            }, 1000);
        });
        
        // Handle page errors
        window.addEventListener('error', (error) => {
            log(`‚ùå JavaScript Error: ${error.message}`, 'error');
        });
    </script>

    <!-- DreamSeed Unified Navigation -->
    <script src="/components/unified-header.js"></script>
</body>
</html>