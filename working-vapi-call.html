<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSeed - Voice Consultation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .call-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .call-option {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px 20px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .call-option:hover {
            transform: translateY(-5px);
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .call-option h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .call-option .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .phone-input {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .phone-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1em;
            text-align: center;
        }
        
        .phone-input input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            min-height: 60px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .web-call-area {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
        }
        
        @media (max-width: 600px) {
            .call-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Start Your Business Consultation</h1>
        <p>Choose how you'd like to connect with our AI business consultant</p>
        
        <div class="call-options">
            <div class="call-option" onclick="selectCallType('phone')">
                <div class="icon">üìû</div>
                <h3>Phone Call</h3>
                <p>We'll call your phone number</p>
                <small>Most reliable option</small>
            </div>
            
            <div class="call-option" onclick="selectCallType('callback')">
                <div class="icon">üì≤</div>
                <h3>Call Me Back</h3>
                <p>Schedule a callback within 5 minutes</p>
                <small>Professional consultation</small>
            </div>
        </div>
        
        <!-- Phone Call Setup -->
        <div id="phoneCallSetup" class="phone-input">
            <h3>üìû Phone Call Setup</h3>
            <p style="margin-bottom: 15px;">Enter your phone number to receive a call from our AI consultant</p>
            <input type="tel" id="phoneNumber" placeholder="+1 (555) 123-4567" maxlength="20">
            <div style="margin-top: 15px;">
                <button class="btn" onclick="startPhoneCall()">Call My Phone</button>
                <button class="btn" style="background: #666;" onclick="cancelCall()">Cancel</button>
            </div>
        </div>
        
        <!-- Callback Setup -->
        <div id="callbackSetup" class="phone-input">
            <h3>üì≤ Schedule Callback</h3>
            <p style="margin-bottom: 15px;">We'll call you back within 5 minutes for a consultation</p>
            <input type="tel" id="callbackNumber" placeholder="+1 (555) 123-4567" maxlength="20">
            <div style="margin-top: 15px;">
                <button class="btn" onclick="scheduleCallback()">Schedule Callback</button>
                <button class="btn" style="background: #666;" onclick="cancelCall()">Cancel</button>
            </div>
        </div>
        
        <div id="status" class="status">
            Ready to start your business consultation. Choose an option above.
        </div>
        
        <div style="margin-top: 30px; text-align: left;">
            <h3>üìã What to expect:</h3>
            <ul style="color: rgba(255,255,255,0.9);">
                <li>‚úÖ Friendly AI consultant specialized in business formation</li>
                <li>‚úÖ Questions about your business goals and structure</li>
                <li>‚úÖ Guidance on LLC formation process</li>
                <li>‚úÖ Next steps for your business journey</li>
                <li>‚úÖ Call typically lasts 5-10 minutes</li>
            </ul>
        </div>
    </div>

    <script>
        let currentCallType = null;
        let isCallActive = false;
        let callId = null;
        
        function updateStatus(message, isLoading = false) {
            const status = document.getElementById('status');
            status.innerHTML = isLoading ? 
                `<span class="loading"></span>${message}` : 
                message;
        }
        
        function selectCallType(type) {
            currentCallType = type;
            
            // Hide all setup areas
            document.getElementById('phoneCallSetup').style.display = 'none';
            document.getElementById('callbackSetup').style.display = 'none';
            
            // Show selected setup
            if (type === 'phone') {
                document.getElementById('phoneCallSetup').style.display = 'block';
                updateStatus('üìû Immediate call selected. Enter your number below.');
            } else if (type === 'callback') {
                document.getElementById('callbackSetup').style.display = 'block';
                updateStatus('üì≤ Callback selected. We\'ll call you within 5 minutes.');
            }
        }
        
        function cancelCall() {
            document.getElementById('phoneCallSetup').style.display = 'none';
            document.getElementById('callbackSetup').style.display = 'none';
            currentCallType = null;
            updateStatus('Ready to start your business consultation. Choose an option above.');
        }
        
        async function startPhoneCall() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            if (!phoneNumber) {
                updateStatus('‚ùå Please enter your phone number');
                return;
            }
            
            if (!/^[\+]?[1-9][\d]{10,14}$/.test(phoneNumber.replace(/[\s\-\(\)]/g, ''))) {
                updateStatus('‚ùå Please enter a valid phone number (e.g., +1234567890)');
                return;
            }
            
            isCallActive = true;
            updateStatus('üìû Initiating phone call...', true);
            
            try {
                // Get VAPI configuration
                const configResponse = await fetch('/api/vapi-config');
                if (!configResponse.ok) {
                    throw new Error('Could not load VAPI configuration');
                }
                const config = await configResponse.json();
                
                updateStatus('üìû Connecting to VAPI...', true);
                
                // Check for required Twilio configuration
                if (!config.twilioAccountSid) {
                    throw new Error('Twilio Account SID not configured. Please add TWILIO_ACCOUNT_SID to environment variables.');
                }
                
                // Create phone call via VAPI API
                const callResponse = await fetch('https://api.vapi.ai/call', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.privateKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'outboundPhoneCall',
                        phoneNumber: {
                            twilioPhoneNumber: phoneNumber,
                            twilioAccountSid: config.twilioAccountSid
                        },
                        assistant: {
                            model: {
                                provider: 'openai',
                                model: 'gpt-3.5-turbo',
                                messages: [{
                                    role: 'system',
                                    content: 'You are a helpful business formation consultant for DreamSeed. Help customers understand the process of forming an LLC. Ask about their business goals, type, and state. Be friendly, professional, and keep the conversation focused on business formation. Limit responses to 2-3 sentences.'
                                }]
                            },
                            voice: {
                                provider: 'playht',
                                voiceId: 'jennifer'
                            },
                            firstMessage: "Hello! This is your AI business consultant from DreamSeed. I'm calling to help you with your LLC formation. What type of business are you looking to start?"
                        }
                    })
                });
                
                if (!callResponse.ok) {
                    const errorText = await callResponse.text();
                    throw new Error(`VAPI call failed: ${callResponse.status} - ${errorText}`);
                }
                
                const callData = await callResponse.json();
                callId = callData.id;
                
                updateStatus(`‚úÖ Call initiated! You should receive a call at ${phoneNumber} within 30 seconds. Call ID: ${callId}`);
                
                // Monitor call status
                setTimeout(() => checkCallStatus(), 5000);
                
            } catch (error) {
                console.error('Phone call error:', error);
                updateStatus(`‚ùå Call failed: ${error.message}`);
                isCallActive = false;
            }
        }
        
        async function scheduleCallback() {
            const phoneNumber = document.getElementById('callbackNumber').value.trim();
            
            if (!phoneNumber) {
                updateStatus('‚ùå Please enter your phone number');
                return;
            }
            
            if (!/^[\+]?[1-9][\d]{10,14}$/.test(phoneNumber.replace(/[\s\-\(\)]/g, ''))) {
                updateStatus('‚ùå Please enter a valid phone number (e.g., +1234567890)');
                return;
            }
            
            isCallActive = true;
            updateStatus('üì≤ Scheduling your callback...', true);
            
            try {
                // Get VAPI configuration
                const configResponse = await fetch('/api/vapi-config');
                if (!configResponse.ok) {
                    throw new Error('Could not load VAPI configuration');
                }
                const config = await configResponse.json();
                
                updateStatus('üì≤ Setting up callback with VAPI...', true);
                
                // Check for required Twilio configuration
                if (!config.twilioAccountSid) {
                    throw new Error('Twilio Account SID not configured. Please add TWILIO_ACCOUNT_SID to environment variables.');
                }
                
                // Create callback via VAPI API
                const callResponse = await fetch('https://api.vapi.ai/call', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.privateKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'outboundPhoneCall',
                        phoneNumber: {
                            twilioPhoneNumber: phoneNumber,
                            twilioAccountSid: config.twilioAccountSid
                        },
                        assistant: {
                            model: {
                                provider: 'openai',
                                model: 'gpt-3.5-turbo',
                                messages: [{
                                    role: 'system',
                                    content: 'You are a helpful business formation consultant for DreamSeed. This is a scheduled callback. Help customers understand the process of forming an LLC. Ask about their business goals, type, and state. Be friendly, professional, and keep the conversation focused on business formation. Limit responses to 2-3 sentences.'
                                }]
                            },
                            voice: {
                                provider: 'playht',
                                voiceId: 'jennifer'
                            },
                            firstMessage: "Hello! This is your scheduled callback from DreamSeed. I'm your AI business consultant calling to help you with your LLC formation. What type of business are you looking to start?"
                        }
                    })
                });
                
                if (!callResponse.ok) {
                    const errorText = await callResponse.text();
                    throw new Error(`VAPI callback failed: ${callResponse.status} - ${errorText}`);
                }
                
                const callData = await callResponse.json();
                callId = callData.id;
                
                updateStatus(`‚úÖ Callback scheduled! You should receive a call at ${phoneNumber} within 5 minutes. Call ID: ${callId}`);
                
                // Monitor call status
                setTimeout(() => checkCallStatus(), 5000);
                
            } catch (error) {
                console.error('Callback error:', error);
                updateStatus(`‚ùå Callback failed: ${error.message}`);
                isCallActive = false;
            }
        }
        
        async function checkCallStatus() {
            if (!callId) return;
            
            try {
                const config = await fetch('/api/vapi-config').then(r => r.json());
                const statusResponse = await fetch(`https://api.vapi.ai/call/${callId}`, {
                    headers: {
                        'Authorization': `Bearer ${config.privateKey}`
                    }
                });
                
                if (statusResponse.ok) {
                    const callStatus = await statusResponse.json();
                    updateStatus(`üìû Call status: ${callStatus.status || 'In progress'}`);
                    
                    if (callStatus.status === 'ended') {
                        isCallActive = false;
                        updateStatus('‚úÖ Call completed. Thank you for using DreamSeed!');
                    } else if (callStatus.status === 'ringing' || callStatus.status === 'in-progress') {
                        setTimeout(() => checkCallStatus(), 10000);
                    }
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }
        
        function endCall() {
            if (callId) {
                // End call via API
                updateStatus('üìû Ending call...', true);
                // Implementation would go here
            }
            isCallActive = false;
            document.getElementById('callControls').style.display = 'none';
            updateStatus('‚úÖ Call ended. Thank you for using DreamSeed!');
        }
        
        // Test connection on page load
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/vapi-config');
                if (response.ok) {
                    const config = await response.json();
                    updateStatus(`‚úÖ Connected to DreamSeed VAPI system. Ready to start consultation.`);
                } else {
                    updateStatus('‚ùå Could not connect to VAPI system. Please refresh and try again.');
                }
            } catch (error) {
                updateStatus(`‚ùå Connection test failed: ${error.message}`);
            }
        });
    </script>

    <!-- DreamSeed Unified Navigation -->
    <script src="/components/unified-header.js"></script>
</body>
</html>