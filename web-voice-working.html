<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSeed - Working Voice Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .big-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            font-size: 3em;
            cursor: pointer;
            margin: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .start-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .record-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .stop-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .big-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        
        .status {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            min-height: 60px;
        }
        
        .hidden {
            display: none;
        }
        
        .conversation {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
        }
        
        .user-message {
            background: rgba(52, 152, 219, 0.3);
            margin-left: 20px;
        }
        
        .ai-message {
            background: rgba(39, 174, 96, 0.3);
            margin-right: 20px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ DreamSeed AI Voice Assistant</h1>
        <p>Talk to our business formation consultant</p>
        
        <!-- Start Screen -->
        <div id="start-screen">
            <button class="big-button start-btn" id="start-btn">üé§</button>
            <p>Click to start conversation</p>
        </div>
        
        <!-- Recording Screen -->
        <div id="record-screen" class="hidden">
            <button class="big-button record-btn" id="record-btn">üé§</button>
            <button class="big-button stop-btn" id="stop-btn">‚ùå</button>
            <p><strong>üé§ Hold to talk</strong> | <strong>‚ùå End conversation</strong></p>
        </div>
        
        <div class="status" id="status">Ready to start your business consultation</div>
        
        <div class="conversation" id="conversation">
            <div class="ai-message">
                <strong>AI Assistant:</strong> Hi! I'm ready to help you with your LLC formation. Just click the microphone and start talking!
            </div>
        </div>
        
        <audio id="ai-response" controls style="width: 100%; margin: 20px 0; display: none;"></audio>
    </div>

    <script>
        let isRecording = false;
        let mediaRecorder = null;
        let stream = null;
        let audioChunks = [];
        let config = null;
        let conversationHistory = [];
        
        // Get elements
        const startScreen = document.getElementById('start-screen');
        const recordScreen = document.getElementById('record-screen');
        const status = document.getElementById('status');
        const conversation = document.getElementById('conversation');
        const startBtn = document.getElementById('start-btn');
        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const aiAudio = document.getElementById('ai-response');
        
        function updateStatus(msg, loading = false) {
            if (loading) {
                status.innerHTML = `<span class="loading"></span>${msg}`;
            } else {
                status.textContent = msg;
            }
            console.log(msg);
        }
        
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            messageDiv.innerHTML = `<strong>${isUser ? 'You' : 'AI Assistant'}:</strong> ${text}`;
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        // Load VAPI configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/vapi-config');
                if (!response.ok) throw new Error('Config failed');
                config = await response.json();
                updateStatus('‚úÖ AI system connected');
                return true;
            } catch (error) {
                updateStatus('‚ùå AI system connection failed');
                return false;
            }
        }
        
        // Start button click
        startBtn.addEventListener('click', async function() {
            updateStatus('Setting up microphone...', true);
            
            try {
                // Get microphone access
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });
                
                // Setup media recorder
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioChunks = [];
                    await processAudioWithAI(audioBlob);
                };
                
                // Load AI config
                await loadConfig();
                
                updateStatus('‚úÖ Ready! Press and hold microphone to talk');
                startScreen.classList.add('hidden');
                recordScreen.classList.remove('hidden');
                
            } catch (error) {
                updateStatus('‚ùå Microphone setup failed: ' + error.message);
            }
        });
        
        // Record button click
        recordBtn.addEventListener('click', function() {
            if (!isRecording) {
                // Start recording
                updateStatus('üî¥ Recording... speak now!');
                audioChunks = [];
                mediaRecorder.start();
                isRecording = true;
                recordBtn.textContent = '‚èπÔ∏è';
                recordBtn.style.background = 'linear-gradient(45deg, #e67e22, #d35400)';
            } else {
                // Stop recording
                updateStatus('Processing your voice...', true);
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.textContent = 'üé§';
                recordBtn.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
            }
        });
        
        // Stop button click
        stopBtn.addEventListener('click', function() {
            updateStatus('Ending conversation...', true);
            
            if (isRecording && mediaRecorder) {
                mediaRecorder.stop();
            }
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            isRecording = false;
            startScreen.classList.remove('hidden');
            recordScreen.classList.add('hidden');
            updateStatus('‚úÖ Conversation ended. Thanks for using DreamSeed!');
            
            // Add final message
            addMessage('Thank you for your consultation! Feel free to start a new conversation anytime.', false);
        });
        
        // Process audio with AI (simulated for now)
        async function processAudioWithAI(audioBlob) {
            try {
                updateStatus('ü§ñ AI is thinking...', true);
                
                // For now, simulate the AI processing
                // In a real implementation, you would:
                // 1. Send audio to speech-to-text service
                // 2. Send text to VAPI or OpenAI
                // 3. Get AI response
                // 4. Convert response to speech
                
                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Simulate user question detection
                const simulatedUserText = "I want to start an LLC for my consulting business";
                addMessage(simulatedUserText, true);
                
                // Simulate AI response
                const aiResponses = [
                    "Great choice! LLCs are perfect for consulting businesses. What state are you planning to incorporate in?",
                    "That's excellent! For consulting, an LLC provides liability protection and tax flexibility. Do you have a business name in mind?",
                    "Perfect! Consulting LLCs are very common. Would you like to know about our formation packages?",
                    "Wonderful! An LLC will protect your personal assets. Have you thought about whether you'll have business partners?"
                ];
                
                const randomResponse = aiResponses[Math.floor(Math.random() * aiResponses.length)];
                addMessage(randomResponse, false);
                
                updateStatus('‚úÖ AI responded! Press microphone to continue');
                
                // Simulate text-to-speech (you could integrate real TTS here)
                updateStatus('üîä AI speaking... (simulated voice response)');
                setTimeout(() => {
                    updateStatus('Your turn - press microphone to respond');
                }, 3000);
                
            } catch (error) {
                updateStatus('‚ùå AI processing failed: ' + error.message);
                addMessage('Sorry, I had trouble processing that. Please try again.', false);
            }
        }
        
        // Initialize
        updateStatus('Click the microphone to start your business consultation');
    </script>

    <!-- DreamSeed Unified Navigation -->
    <script src="/components/unified-header.js"></script>
</body>
</html>